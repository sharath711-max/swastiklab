{% extends 'dashboard/templates/table.html' %}

{% block content %}
	<div class="card">
		<div class="card-body">
			<div class="d-flex justify-content-between align-items-center mb-1">
				<div class="d-flex">
					<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
						<i class="uil-plus me-2"></i>
						Add Item
					</button>
				</div>
				<div class="text-sm-end" id="button_container"></div>
			</div>
			<table id="table" class="table table-striped" style="width:100%">
				<thead>
					<tr>
						<th>Name</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody>
					{% for item in Item.all() %}
						<tr>
							<td>{{ item.name }}</td>
							<td>
								<div class="d-flex justify-content-evenly">
									<a class="edit" data-item-id="{{ item.id }}">
										<i class="uil-pen"></i>
									</a>
								</div>
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>

	<div id="addItemModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h3 class="modal-title">Add Item</h3>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body m-3">
					<form id="addItemForm">
						<div class="row">
							<div class="col-lg-12">
								<div class="input-group input-group-lg mb-3">
									<span class="input-group-text fw-bold">Name</span>
									<input class="form-control" name="name" type="text" required>
								</div>
							</div>
						</div>
						<div class="d-flex justify-content-end">
							<button type="submit" class="btn btn-primary btn-lg m-1">
								Add
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<div id="editItemModal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h3 class="modal-title">Edit Item</h3>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body m-3">
					<form id="editItemForm">
						<div class="row">
							<div class="col-lg-12">
								<div class="input-group input-group-lg mb-3">
									<span class="input-group-text fw-bold">Name</span>
									<input id="itemName" class="form-control" name="name" type="text" required>
								</div>
							</div>
						</div>
						<div class="d-flex justify-content-end">
							<button type="submit" class="btn btn-primary btn-lg m-1">
								Save
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
{% endblock content %}

{% block body %}
	{{ super() }}
	<script type="application/javascript">
        const table = $("#table").DataTable({
            language: {
                paginate: {
                    previous: "<i class='uil-angle-left'>",
                    next: "<i class='uil-angle-right'>"
                },
                info: "Showing " + name + " _START_ to _END_ of _TOTAL_",
                lengthMenu: 'Display <select class=\'form-select form-select-sm ms-1 me-1\'><option value="5">5</option><option value="10">10</option><option value="20">20</option><option value="-1">All</option></select> ' + name,
            },
            pageLength: 20,
            drawCallback: function () {
                $(".dataTables_paginate > .pagination").addClass("pagination-rounded");
            },
            columnDefs: [
                {orderable: false, targets: -1}
            ],
            fixedHeader: true,
            order: [[0, 'asc']],
            ordering: true,
            buttons: [
                {
                    extend: 'copyHtml5',
                    exportOptions: {
                        columns: 'th:not(:last-child)',
                        modifier: {search: 'applied', order: 'applied', page: 'current'}
                    }
                },
                {
                    extend: 'excelHtml5',
                    title: '{{ title }}',
                    exportOptions: {
                        columns: 'th:not(:last-child)',
                        modifier: {search: 'applied', order: 'applied', page: 'current'}
                    }
                },
                {
                    extend: 'pdfHtml5',
                    exportOptions: {
                        columns: 'th:not(:last-child)',
                        modifier: {search: 'applied', order: 'applied', page: 'current'}
                    }
                },
            ],
            responsive: true,
        });
        table.buttons().container().appendTo("#button_container");
        const copy_button = $('.buttons-copy');
        const export_button = $('.buttons-excel');
        const pdf_button = $('.buttons-pdf');
        copy_button.removeClass('btn-secondary').addClass('btn-light mb-2 me-1');
        copy_button.html('<i class="uil-pathfinder"></i> Copy');
        export_button.removeClass('btn-secondary').addClass('btn-light mb-2 me-1');
        export_button.html('<i class="uil-export"></i> Export');
        pdf_button.removeClass('btn-secondary').addClass('btn-light mb-2 me-1');
        pdf_button.html('<i class="uil-file-alt"></i> PDF');

        let addItemModal = $("#addItemModal");
        let addItemForm = $("#addItemForm");
        addItemModal.on('show.bs.modal', function () {
            addItemForm.trigger('reset');
            addItemForm.on('submit', function (e) {
                e.preventDefault();
                let data = {};
                $.each($(this).serializeArray(), function (i, field) {
                    if (field.value.trim() !== "") {
                        data[field.name] = field.value.trim();
                    }
                });
                $.ajax({
                    data: JSON.stringify(data),
                    type: 'POST',
                    url: '/api/item/',
                    contentType: 'application/json',
                }).done(function (data, status, xhr) {
                    location.reload();
                }).fail(function (xhr, status, e) {
                    console.log(xhr);
                    notyf.error(xhr.responseJSON.message);
                });
            });
        });

        let editItemModal = $('#editItemModal');
        let editItemForm = $('#editItemForm');
        $(document).on('click', '.edit', function () {
            let itemId = parseInt($(this).attr('data-item-id'));
            $.ajax({
                type: 'GET',
                url: '/api/item/' + itemId + '/',
                contentType: 'application/json',
            }).done(function (data, status, xhr) {
                $("#itemName").val(data.item.name);
                editItemModal.modal('show');
            }).fail(function (xhr, status, e) {
                console.log(xhr);
                notyf.error(xhr.responseJSON.message);
            });

            editItemForm.on('submit', function (e) {
                e.preventDefault();
                let data = {};
                $.each($(this).serializeArray(), function (i, field) {
                    if (field.value.trim() !== "") {
                        data[field.name] = field.value.trim();
                    }
                });
                $.ajax({
                    data: JSON.stringify(data),
                    type: 'PUT',
                    url: '/api/item/' + itemId + '/',
                    contentType: 'application/json',
                }).done(function (data, status, xhr) {
                    location.reload();
                }).fail(function (xhr, status, e) {
                    console.log(xhr);
                    notyf.error(xhr.responseJSON.message);
                });
            });
        });
	</script>
{% endblock %}
